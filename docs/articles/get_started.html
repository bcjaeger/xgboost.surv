<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Getting started with xgboost.surv • xgboost.surv</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/all.min.css" integrity="sha256-nAmazAk6vS34Xqo0BSrTb+abbtFlgsFK7NKSi6o7Y78=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/v4-shims.min.css" integrity="sha256-6qHlizsOWFskGlwVOKuns+D1nB6ssZrHQrNj1wGplHc=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Getting started with xgboost.surv">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">xgboost.surv</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/get_started.html">Getting started with xgboost.surv</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/bcjaeger/xgboost.surv">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Getting started with xgboost.surv</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/bcjaeger/xgboost.surv/blob/master/vignettes/get_started.Rmd"><code>vignettes/get_started.Rmd</code></a></small>
      <div class="hidden name"><code>get_started.Rmd</code></div>

    </div>

    
    
<div id="xgboost-surv" class="section level1">
<h1 class="hasAnchor">
<a href="#xgboost-surv" class="anchor"></a><code>xgboost.surv</code>
</h1>
<p>Gradient boosted decision trees are an excellent machine learning algorithm to develop prediction functions. For analyses with censored outcomes, there are a number of ways to leverage the popular and efficient R package ‘xgboost’. The <code>xgboost.surv</code> package provides a framework to help you engage with these types of risk prediction analyses using <code>xgboost</code>.</p>
<div id="getting-started" class="section level2">
<h2 class="hasAnchor">
<a href="#getting-started" class="anchor"></a>Getting started</h2>
<p>The following example shows how the <code>xgboost.surv</code> package can be used to fit, tune, and draw survival predictions from <code>xgboost</code> decision tree ensembles. We start by loading packages needed for the analysis.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" title="1"></a>
<a class="sourceLine" id="cb1-2" title="2"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(xgboost.surv)</a>
<a class="sourceLine" id="cb1-3" title="3"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(survival)</a>
<a class="sourceLine" id="cb1-4" title="4"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(xgboost)</a>
<a class="sourceLine" id="cb1-5" title="5"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(prodlim)</a>
<a class="sourceLine" id="cb1-6" title="6"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(tibble)</a>
<a class="sourceLine" id="cb1-7" title="7"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(dplyr)</a>
<a class="sourceLine" id="cb1-8" title="8"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb1-9" title="9"><span class="co">#&gt; Attaching package: 'dplyr'</span></a>
<a class="sourceLine" id="cb1-10" title="10"><span class="co">#&gt; The following object is masked from 'package:xgboost':</span></a>
<a class="sourceLine" id="cb1-11" title="11"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb1-12" title="12"><span class="co">#&gt;     slice</span></a>
<a class="sourceLine" id="cb1-13" title="13"><span class="co">#&gt; The following objects are masked from 'package:stats':</span></a>
<a class="sourceLine" id="cb1-14" title="14"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb1-15" title="15"><span class="co">#&gt;     filter, lag</span></a>
<a class="sourceLine" id="cb1-16" title="16"><span class="co">#&gt; The following objects are masked from 'package:base':</span></a>
<a class="sourceLine" id="cb1-17" title="17"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb1-18" title="18"><span class="co">#&gt;     intersect, setdiff, setequal, union</span></a>
<a class="sourceLine" id="cb1-19" title="19"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(purrr)</a>
<a class="sourceLine" id="cb1-20" title="20"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(pec)</a></code></pre></div>
</div>
<div id="mayo-clinic-primary-biliary-cirrhosis-data" class="section level2">
<h2 class="hasAnchor">
<a href="#mayo-clinic-primary-biliary-cirrhosis-data" class="anchor"></a>Mayo Clinic Primary Biliary Cirrhosis Data</h2>
<p>This data is from the Mayo Clinic trial in primary biliary cirrhosis (PBC) of the liver conducted between 1974 and 1984. A total of 424 PBC patients, referred to Mayo Clinic during that ten-year interval, met eligibility criteria for the randomized placebo controlled trial of the drug D-penicillamine. The first 312 cases in the data set participated in the randomized trial and contain largely complete data. The additional 112 cases did not participate in the clinical trial, but consented to have basic measurements recorded and to be followed for survival. Six of those cases were lost to follow-up shortly after diagnosis, so the data here are on an additional 106 cases as well as the 312 randomized participants.</p>
<p>The current analysis will split the data into two sets (a training set and testing set). In the code block below, we load and split the <code>pbc</code> data:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" title="1"></a>
<a class="sourceLine" id="cb2-2" title="2"><span class="kw"><a href="https://rdrr.io/r/utils/data.html">data</a></span>(<span class="st">'pbc'</span>, <span class="dt">package =</span> <span class="st">'survival'</span>)</a>
<a class="sourceLine" id="cb2-3" title="3"></a>
<a class="sourceLine" id="cb2-4" title="4"><span class="co"># remove id column and modify status so that </span></a>
<a class="sourceLine" id="cb2-5" title="5"><span class="co">#  0 = lost to follow-up or transplant</span></a>
<a class="sourceLine" id="cb2-6" title="6"><span class="co">#  1 = died</span></a>
<a class="sourceLine" id="cb2-7" title="7"></a>
<a class="sourceLine" id="cb2-8" title="8">df_analysis &lt;-<span class="st"> </span><span class="kw">as_tibble</span>(pbc) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb2-9" title="9"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">status =</span> <span class="kw"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(status<span class="op">==</span><span class="dv">2</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb2-10" title="10"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>id)</a>
<a class="sourceLine" id="cb2-11" title="11"></a>
<a class="sourceLine" id="cb2-12" title="12"><span class="co"># create vector that contains row numbers</span></a>
<a class="sourceLine" id="cb2-13" title="13"><span class="co"># that will be used in the training set.</span></a>
<a class="sourceLine" id="cb2-14" title="14">nobs &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(df_analysis)</a>
<a class="sourceLine" id="cb2-15" title="15"></a>
<a class="sourceLine" id="cb2-16" title="16"><span class="kw"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="dv">329</span>)</a>
<a class="sourceLine" id="cb2-17" title="17"></a>
<a class="sourceLine" id="cb2-18" title="18">train_index &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/sample.html">sample</a></span>(</a>
<a class="sourceLine" id="cb2-19" title="19">  <span class="dt">x =</span> <span class="dv">1</span><span class="op">:</span>nobs,</a>
<a class="sourceLine" id="cb2-20" title="20">  <span class="dt">size =</span> <span class="kw"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span>(nobs <span class="op">*</span><span class="st"> </span><span class="dv">3</span><span class="op">/</span><span class="dv">4</span>),</a>
<a class="sourceLine" id="cb2-21" title="21">  <span class="dt">replace =</span> <span class="ot">FALSE</span></a>
<a class="sourceLine" id="cb2-22" title="22">)</a>
<a class="sourceLine" id="cb2-23" title="23"></a>
<a class="sourceLine" id="cb2-24" title="24">df_train &lt;-<span class="st"> </span>df_analysis[train_index, ]</a>
<a class="sourceLine" id="cb2-25" title="25">df_test &lt;-<span class="st"> </span>df_analysis[<span class="op">-</span>train_index, ]</a></code></pre></div>
<p>Using the training set, we will develop a number of <code>xgboost</code> survival models with different sets of tuning parameters. The parameters we will consider are the maximum depth of decision trees (<code>max_depth</code>) and the minimum sum of instance weight (hessian) needed in a child node of decision trees.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" title="1"></a>
<a class="sourceLine" id="cb3-2" title="2">df_params &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/expand.grid.html">expand.grid</a></span>(</a>
<a class="sourceLine" id="cb3-3" title="3">  <span class="dt">max_depth =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">4</span>,</a>
<a class="sourceLine" id="cb3-4" title="4">  <span class="dt">eta =</span> <span class="fl">0.025</span>,</a>
<a class="sourceLine" id="cb3-5" title="5">  <span class="dt">min_child_weight =</span> <span class="kw"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="dv">1</span>, <span class="dv">6</span>, <span class="dt">by =</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb3-6" title="6">)</a>
<a class="sourceLine" id="cb3-7" title="7"></a>
<a class="sourceLine" id="cb3-8" title="8"><span class="kw">as_tibble</span>(df_params)</a>
<a class="sourceLine" id="cb3-9" title="9"><span class="co">#&gt; # A tibble: 24 x 3</span></a>
<a class="sourceLine" id="cb3-10" title="10"><span class="co">#&gt;    max_depth   eta min_child_weight</span></a>
<a class="sourceLine" id="cb3-11" title="11"><span class="co">#&gt;        &lt;int&gt; &lt;dbl&gt;            &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb3-12" title="12"><span class="co">#&gt;  1         1 0.025                1</span></a>
<a class="sourceLine" id="cb3-13" title="13"><span class="co">#&gt;  2         2 0.025                1</span></a>
<a class="sourceLine" id="cb3-14" title="14"><span class="co">#&gt;  3         3 0.025                1</span></a>
<a class="sourceLine" id="cb3-15" title="15"><span class="co">#&gt;  4         4 0.025                1</span></a>
<a class="sourceLine" id="cb3-16" title="16"><span class="co">#&gt;  5         1 0.025                2</span></a>
<a class="sourceLine" id="cb3-17" title="17"><span class="co">#&gt;  6         2 0.025                2</span></a>
<a class="sourceLine" id="cb3-18" title="18"><span class="co">#&gt;  7         3 0.025                2</span></a>
<a class="sourceLine" id="cb3-19" title="19"><span class="co">#&gt;  8         4 0.025                2</span></a>
<a class="sourceLine" id="cb3-20" title="20"><span class="co">#&gt;  9         1 0.025                3</span></a>
<a class="sourceLine" id="cb3-21" title="21"><span class="co">#&gt; 10         2 0.025                3</span></a>
<a class="sourceLine" id="cb3-22" title="22"><span class="co">#&gt; # ... with 14 more rows</span></a></code></pre></div>
</div>
<div id="as_sgb_params" class="section level2">
<h2 class="hasAnchor">
<a href="#as_sgb_params" class="anchor"></a><code>as_sgb_params</code>
</h2>
<p>The model fitting functions in <code>xgboost</code> rely heavily on the <code>params</code> argument. <code>params</code> should be a named list containing name-value pairs for tuning parameters that impact how decision trees are formed (e.g., <code>params = list(max_depth = 1)</code>). In addition to tuning parameters, task parameters can be included in <code>params</code> (e.g., <code>objective = reg:logistic</code>). This makes it possible to pass parameters into <code>xgboost</code> so that a prediction function will be developed for survival data. However, instructions on how to set up <code>xgboost</code> for survival problems are not included in the <code>xgboost</code> help page, which might make it difficult for analysts to use this great feature of the package. <code><a href="../reference/as_sgb_params.html">sgb_params()</a></code> and <code>as_sgb_params</code> are helper functions that take a normal list and append two items to it:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" title="1"></a>
<a class="sourceLine" id="cb4-2" title="2"><span class="kw"><a href="../reference/as_sgb_params.html">sgb_params</a></span>(<span class="dt">max_depth =</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb4-3" title="3"><span class="co">#&gt; $max_depth</span></a>
<a class="sourceLine" id="cb4-4" title="4"><span class="co">#&gt; [1] 1</span></a>
<a class="sourceLine" id="cb4-5" title="5"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb4-6" title="6"><span class="co">#&gt; $objective</span></a>
<a class="sourceLine" id="cb4-7" title="7"><span class="co">#&gt; [1] "survival:cox"</span></a>
<a class="sourceLine" id="cb4-8" title="8"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb4-9" title="9"><span class="co">#&gt; $eval_metric</span></a>
<a class="sourceLine" id="cb4-10" title="10"><span class="co">#&gt; [1] "cox-nloglik"</span></a>
<a class="sourceLine" id="cb4-11" title="11"></a>
<a class="sourceLine" id="cb4-12" title="12"><span class="kw"><a href="../reference/as_sgb_params.html">as_sgb_params</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="dt">max_depth =</span> <span class="dv">1</span>))</a>
<a class="sourceLine" id="cb4-13" title="13"><span class="co">#&gt; $max_depth</span></a>
<a class="sourceLine" id="cb4-14" title="14"><span class="co">#&gt; [1] 1</span></a>
<a class="sourceLine" id="cb4-15" title="15"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb4-16" title="16"><span class="co">#&gt; $objective</span></a>
<a class="sourceLine" id="cb4-17" title="17"><span class="co">#&gt; [1] "survival:cox"</span></a>
<a class="sourceLine" id="cb4-18" title="18"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb4-19" title="19"><span class="co">#&gt; $eval_metric</span></a>
<a class="sourceLine" id="cb4-20" title="20"><span class="co">#&gt; [1] "cox-nloglik"</span></a></code></pre></div>
<p>One major advantage of using these functions is that you won’t have to remember the text fields of ‘survival:cox’ and ‘cox-nloglik’! I have used <code>xgboost</code> in survival analyses for ~2 years and I still can’t remember these. The code below modifies our data grid of tuning parameters by turning each row into a list, then passing each list into the <code>as_sgb_params</code> function.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" title="1"></a>
<a class="sourceLine" id="cb5-2" title="2">prm_list &lt;-<span class="st"> </span>df_params <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb5-3" title="3"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/r/base/apply.html">apply</a></span>(<span class="dv">1</span>, as.list) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb5-4" title="4"><span class="st">  </span><span class="kw">map</span>(as_sgb_params)</a></code></pre></div>
</div>
<div id="cat_herding" class="section level2">
<h2 class="hasAnchor">
<a href="#cat_herding" class="anchor"></a><code>cat_herding</code>
</h2>
<p>A necessary pre-processing step for datasets with ‘text’ variables is dummy coding. For example, the column named <code>sex</code> in <code>pbc</code> contains values of ‘f’ and ‘m’ for females and males, respectively. <code>xgboost</code> requires columns like this be coded as a collection of numeric indicator columns, e.g. <code>sex_m = 1</code> if <code>sex = male</code>, and 0 otherwise.</p>
<p>Often, training data have a categorical variable with a rare value that occurs only in the training data and not the testing data. This will cause an error when the model looks for a certain variable in the testing data and doesn’t see it. The <code>xgboost.surv</code> package provides three functions to deal with categorical variables (<code>cats</code>): <code>cat_spread</code>, <code>cat_transfer</code>, and <code>cat_gather</code>. In the code below, we use the first two of these functions to avoid dummy columns being created in the training data and not the testing data.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" title="1"></a>
<a class="sourceLine" id="cb6-2" title="2">xgb_train &lt;-<span class="st"> </span><span class="kw"><a href="../reference/cat_spread.html">cat_spread</a></span>(df_train)</a>
<a class="sourceLine" id="cb6-3" title="3"></a>
<a class="sourceLine" id="cb6-4" title="4">xgb_test &lt;-<span class="st"> </span>df_test <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb6-5" title="5"><span class="st">  </span><span class="kw"><a href="../reference/cat_transfer.html">cat_transfer</a></span>(<span class="dt">from =</span> df_train) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb6-6" title="6"><span class="st">  </span><span class="kw"><a href="../reference/cat_spread.html">cat_spread</a></span>()</a></code></pre></div>
</div>
<div id="sgb_label" class="section level2">
<h2 class="hasAnchor">
<a href="#sgb_label" class="anchor"></a><code>sgb_label</code>
</h2>
<p>Survival analysis outcomes are based on two numeric vectors: <code>time</code> and <code>status</code>. <code>time</code> indicates time until the event, and <code>status</code> indicates what event occurred. Generally, <code>status = 1</code> indicates that the event of interest occurred, and <code>status = 0</code> indicates censoring. <code>xgboost</code> models require these columns be combined into a single vector of <code>time</code> values. Specifically, censored observations in this vector will have negative time values, while non-censored observations will have positive time values. The <code>sgb_label</code> function creates this type of vector when given <code>time</code> and <code>status</code> values:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" title="1"></a>
<a class="sourceLine" id="cb7-2" title="2">train_label &lt;-<span class="st"> </span><span class="kw"><a href="../reference/sgb_label.html">sgb_label</a></span>(df_train<span class="op">$</span>time, df_train<span class="op">$</span>status)</a>
<a class="sourceLine" id="cb7-3" title="3"></a>
<a class="sourceLine" id="cb7-4" title="4">train_label[<span class="dv">1</span><span class="op">:</span><span class="dv">10</span>]</a>
<a class="sourceLine" id="cb7-5" title="5"><span class="co">#&gt;  [1]  2689 -3092 -4256  1037 -3336 -2716  1427 -1481  -691  2256</span></a></code></pre></div>
</div>
<div id="sgb_data-and-sgb_fit" class="section level2">
<h2 class="hasAnchor">
<a href="#sgb_data-and-sgb_fit" class="anchor"></a><code>sgb_data</code> and <code>sgb_fit</code>
</h2>
<p>The interface for providing data to <code>xgboost</code> functions is slightly different from the standard interface given by the <code>stats</code> package, i.e., providing a <code>data.frame</code> object comprising all of the analysis variables. Instead, <code>xgboost</code> functions require the following inputs:</p>
<ol style="list-style-type: decimal">
<li><p>A <code>matrix</code> (not a <code>data.frame</code>) where each column is a predictor variable.</p></li>
<li><p>A <code>numeric</code> vector of labels (i.e., values of the outcome variable).</p></li>
</ol>
<p><em>Side note:</em> Another option is to supply an <code>xgb.DMatrix</code> object, but <code>xgboost</code> will automatically complete this task if 1. and 2. above are supplied.</p>
<p>It can be a little clunky to go from a <code>data.frame</code> to a <code>matrix</code> + a <code>numeric</code> vector. To make the workflow a little cleaner, <code>sgb_data</code> and <code>as_sgb_data</code> can be applied directly to a <code>data.frame</code> and give back the exact components that <code>xgboost</code> functions need.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" title="1"></a>
<a class="sourceLine" id="cb8-2" title="2">xgb_train &lt;-<span class="st"> </span><span class="kw"><a href="../reference/sgb_data.html">as_sgb_data</a></span>(xgb_train, <span class="dt">time =</span> time, <span class="dt">status =</span> status)</a>
<a class="sourceLine" id="cb8-3" title="3">xgb_test &lt;-<span class="st"> </span><span class="kw"><a href="../reference/sgb_data.html">as_sgb_data</a></span>(xgb_test, <span class="dt">time =</span> time, <span class="dt">status =</span> status)</a></code></pre></div>
<p>Now that the data are ready, we can call <code>sgb_fit</code>, a wrapper to the <code>xgboost</code> function, to fit our models. Since we have <code><a href="https://rdrr.io/r/base/nrow.html">nrow(df_params)</a></code> models to fit, we use the <code><a href="https://purrr.tidyverse.org/reference/map.html">purrr::map</a></code> function to fit one model for each set of tuning parameters.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" title="1"></a>
<a class="sourceLine" id="cb9-2" title="2">fits &lt;-<span class="st"> </span><span class="kw">map</span>(</a>
<a class="sourceLine" id="cb9-3" title="3">  <span class="dt">.x =</span> prm_list, </a>
<a class="sourceLine" id="cb9-4" title="4">  <span class="dt">.f =</span> <span class="cf">function</span>(.params){</a>
<a class="sourceLine" id="cb9-5" title="5">    <span class="kw"><a href="../reference/sgb_fit.html">sgb_fit</a></span>(</a>
<a class="sourceLine" id="cb9-6" title="6">      <span class="dt">sgb_df =</span> xgb_train,</a>
<a class="sourceLine" id="cb9-7" title="7">      <span class="dt">params =</span> .params,</a>
<a class="sourceLine" id="cb9-8" title="8">      <span class="dt">nrounds =</span> <span class="dv">100</span>,</a>
<a class="sourceLine" id="cb9-9" title="9">      <span class="dt">verbose =</span> <span class="ot">FALSE</span></a>
<a class="sourceLine" id="cb9-10" title="10">    )</a>
<a class="sourceLine" id="cb9-11" title="11">  }</a>
<a class="sourceLine" id="cb9-12" title="12">)</a>
<a class="sourceLine" id="cb9-13" title="13"></a>
<a class="sourceLine" id="cb9-14" title="14"><span class="co"># take a peek at the contents of an sgb_booster</span></a>
<a class="sourceLine" id="cb9-15" title="15"><span class="kw">enframe</span>(fits[[<span class="dv">1</span>]])</a>
<a class="sourceLine" id="cb9-16" title="16"><span class="co">#&gt; # A tibble: 4 x 2</span></a>
<a class="sourceLine" id="cb9-17" title="17"><span class="co">#&gt;   name                 value      </span></a>
<a class="sourceLine" id="cb9-18" title="18"><span class="co">#&gt;   &lt;chr&gt;                &lt;list&gt;     </span></a>
<a class="sourceLine" id="cb9-19" title="19"><span class="co">#&gt; 1 fit                  &lt;xgb.Bstr&gt; </span></a>
<a class="sourceLine" id="cb9-20" title="20"><span class="co">#&gt; 2 label                &lt;dbl [313]&gt;</span></a>
<a class="sourceLine" id="cb9-21" title="21"><span class="co">#&gt; 3 eval_times           &lt;dbl [82]&gt; </span></a>
<a class="sourceLine" id="cb9-22" title="22"><span class="co">#&gt; 4 training_predictions &lt;dbl [313]&gt;</span></a></code></pre></div>
<p>Now we use the <code>predict</code> function to generate predicted survival probabilities for the testing data. Prediction of survival probability for the Cox proportional hazards model requires an estimate of the baseline hazard function as well as log-hazard predicted values. Fortunately, the <code>gbm</code> package offers a handy function to estimate baseline hazard values, and <code>xgboost.surv</code> leverages this function internally.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" title="1"></a>
<a class="sourceLine" id="cb10-2" title="2">prds &lt;-<span class="st"> </span><span class="kw">map</span>(</a>
<a class="sourceLine" id="cb10-3" title="3">  <span class="dt">.x =</span> fits, </a>
<a class="sourceLine" id="cb10-4" title="4">  <span class="dt">.f =</span> predict,</a>
<a class="sourceLine" id="cb10-5" title="5">  <span class="dt">new_data =</span> xgb_test</a>
<a class="sourceLine" id="cb10-6" title="6">)</a>
<a class="sourceLine" id="cb10-7" title="7"></a>
<a class="sourceLine" id="cb10-8" title="8"><span class="co"># survival predictions at </span></a>
<a class="sourceLine" id="cb10-9" title="9"><span class="co">#  first 5 times, </span></a>
<a class="sourceLine" id="cb10-10" title="10"><span class="co">#  for first 5 patients, </span></a>
<a class="sourceLine" id="cb10-11" title="11"><span class="co">#  using the first sgb_booster</span></a>
<a class="sourceLine" id="cb10-12" title="12"></a>
<a class="sourceLine" id="cb10-13" title="13">prds[[<span class="dv">1</span>]][<span class="dv">1</span><span class="op">:</span><span class="dv">5</span>,<span class="dv">1</span><span class="op">:</span><span class="dv">5</span>]</a>
<a class="sourceLine" id="cb10-14" title="14"><span class="co">#&gt;           [,1]      [,2]      [,3]      [,4]      [,5]</span></a>
<a class="sourceLine" id="cb10-15" title="15"><span class="co">#&gt; [1,] 0.9578512 0.9562684 0.9546850 0.9530895 0.9514761</span></a>
<a class="sourceLine" id="cb10-16" title="16"><span class="co">#&gt; [2,] 0.9635731 0.9622010 0.9608279 0.9594441 0.9580443</span></a>
<a class="sourceLine" id="cb10-17" title="17"><span class="co">#&gt; [3,] 0.9647897 0.9634625 0.9621344 0.9607957 0.9594417</span></a>
<a class="sourceLine" id="cb10-18" title="18"><span class="co">#&gt; [4,] 0.8387128 0.8330665 0.8274467 0.8218131 0.8161456</span></a>
<a class="sourceLine" id="cb10-19" title="19"><span class="co">#&gt; [5,] 0.8486009 0.8432675 0.8379568 0.8326306 0.8272699</span></a></code></pre></div>
<p>A user may want to specify <em>when</em> survival predictions should be computed (e.g., at 1, 2, and 3 years in the future). This feature can be set using the <code>eval_times</code> input to the <code>predict</code> function for <code>sgb_booster</code> objects. If <code>eval_times</code> are unspecified, a default set of evaluation times based on the training data event times will be used, and those times are saved as an attribute of the predicted survival probability matrix:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" title="1"></a>
<a class="sourceLine" id="cb11-2" title="2"><span class="co"># the first 5 evaluation times for survival predictions:</span></a>
<a class="sourceLine" id="cb11-3" title="3"><span class="kw"><a href="https://rdrr.io/r/base/attr.html">attr</a></span>(prds[[<span class="dv">1</span>]], <span class="st">'eval_times'</span>)[<span class="dv">1</span><span class="op">:</span><span class="dv">5</span>]</a>
<a class="sourceLine" id="cb11-4" title="4"><span class="co">#&gt; [1] 552 559 597 611 625</span></a></code></pre></div>
</div>
<div id="eval_bscore" class="section level2">
<h2 class="hasAnchor">
<a href="#eval_bscore" class="anchor"></a><code>eval_bscore</code>
</h2>
<p>A widely used metric for assessing accuracy of risk predictions in the integrated Brier score (IBS). The way that IBS applies to survival models is somewhat technical, but it is essentially an average of standard Brier scores across time (recall that survival models can make risk predictions at any given time in the future). Standard Brier scores are similar to squared error in that they are based on the squared difference between observed status (1 or 0) and predicted probability (a number between 1 and 0). Therefore, a Brier score of 0 would indicate a perfect model. The code below computes a Brier score for the first <code>sgb_booster</code> we fit:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" title="1"></a>
<a class="sourceLine" id="cb12-2" title="2">prds[[<span class="dv">1</span>]] <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb12-3" title="3"><span class="st">  </span><span class="kw"><a href="../reference/eval_bscore.html">eval_bscore</a></span>(</a>
<a class="sourceLine" id="cb12-4" title="4">    <span class="dt">label =</span> xgb_test<span class="op">$</span>label,</a>
<a class="sourceLine" id="cb12-5" title="5">    <span class="dt">scale =</span> <span class="ot">FALSE</span></a>
<a class="sourceLine" id="cb12-6" title="6">  )</a>
<a class="sourceLine" id="cb12-7" title="7"><span class="co">#&gt; [1] 0.1476438</span></a></code></pre></div>
<p>Of course, we don’t really know how to interpret the value of a non-zero Brier score without some context. Generally, it is okay to use a Kaplan-Meier survival curve as a reference model, and compare the Brier score of a current model to that of the Kaplan-Meier curve. This is what happens when we set <code>scale = TRUE</code>:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" title="1"></a>
<a class="sourceLine" id="cb13-2" title="2">prds[[<span class="dv">1</span>]] <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb13-3" title="3"><span class="st">  </span><span class="kw"><a href="../reference/eval_bscore.html">eval_bscore</a></span>(</a>
<a class="sourceLine" id="cb13-4" title="4">    <span class="dt">label =</span> xgb_test<span class="op">$</span>label,</a>
<a class="sourceLine" id="cb13-5" title="5">    <span class="dt">scale =</span> <span class="ot">TRUE</span></a>
<a class="sourceLine" id="cb13-6" title="6">  )</a>
<a class="sourceLine" id="cb13-7" title="7"><span class="co">#&gt; [1] 0.2421833</span></a></code></pre></div>
<p>Scaled Brier scores range from negative infinity to 1 (but you will rarely see values below 0). A value of 1 indicates a perfect model, and a value less than zero indicates that the model was less informative than the reference model. Let’s take a look at our collection of models and see which one had the highest scaled integrated Brier score for predictions of the testing data:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" title="1"></a>
<a class="sourceLine" id="cb14-2" title="2"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(ggplot2)</a>
<a class="sourceLine" id="cb14-3" title="3"></a>
<a class="sourceLine" id="cb14-4" title="4">df_params <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb14-5" title="5"><span class="st">  </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb14-6" title="6">    <span class="co"># compute brier scores</span></a>
<a class="sourceLine" id="cb14-7" title="7">    <span class="dt">sbri =</span> <span class="kw">map_dbl</span>(</a>
<a class="sourceLine" id="cb14-8" title="8">      <span class="dt">.x =</span> prds, </a>
<a class="sourceLine" id="cb14-9" title="9">      eval_bscore, </a>
<a class="sourceLine" id="cb14-10" title="10">      <span class="dt">label =</span> xgb_test<span class="op">$</span>label</a>
<a class="sourceLine" id="cb14-11" title="11">    )</a>
<a class="sourceLine" id="cb14-12" title="12">  ) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb14-13" title="13"><span class="st">  </span><span class="co"># make x, y axes variables factors</span></a>
<a class="sourceLine" id="cb14-14" title="14"><span class="st">  </span><span class="co"># (this makes the axes look a little cleaner)</span></a>
<a class="sourceLine" id="cb14-15" title="15"><span class="st">  </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb14-16" title="16">    <span class="dt">max_depth =</span> <span class="kw"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(max_depth),</a>
<a class="sourceLine" id="cb14-17" title="17">    <span class="dt">min_child_weight =</span> <span class="kw"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(min_child_weight)</a>
<a class="sourceLine" id="cb14-18" title="18">  ) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb14-19" title="19"><span class="st">  </span><span class="co"># use ggplot to draw a grid of tuning parameters</span></a>
<a class="sourceLine" id="cb14-20" title="20"><span class="st">  </span><span class="co"># and print the Brier score values for each set </span></a>
<a class="sourceLine" id="cb14-21" title="21"><span class="st">  </span><span class="co"># of tuning parameters on that grid.</span></a>
<a class="sourceLine" id="cb14-22" title="22"><span class="st">  </span><span class="kw">ggplot</span>(</a>
<a class="sourceLine" id="cb14-23" title="23">    <span class="kw">aes</span>(</a>
<a class="sourceLine" id="cb14-24" title="24">      <span class="dt">x =</span> max_depth, </a>
<a class="sourceLine" id="cb14-25" title="25">      <span class="dt">y =</span> min_child_weight, </a>
<a class="sourceLine" id="cb14-26" title="26">      <span class="dt">size =</span> sbri, </a>
<a class="sourceLine" id="cb14-27" title="27">      <span class="dt">label =</span> <span class="kw"><a href="https://rdrr.io/r/base/format.html">format</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(<span class="dv">100</span><span class="op">*</span>sbri, <span class="dv">1</span>), <span class="dt">nsmall =</span> <span class="dv">1</span>))</a>
<a class="sourceLine" id="cb14-28" title="28">  ) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb14-29" title="29"><span class="st">  </span><span class="kw">geom_label</span>(<span class="dt">color =</span> <span class="st">'black'</span>) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb14-30" title="30"><span class="st">  </span><span class="kw">theme_bw</span>() <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb14-31" title="31"><span class="st">  </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">''</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb14-32" title="32"><span class="st">  </span><span class="kw">labs</span>(</a>
<a class="sourceLine" id="cb14-33" title="33">    <span class="dt">x =</span> <span class="st">'Maximum depth of decision tree'</span>,</a>
<a class="sourceLine" id="cb14-34" title="34">    <span class="dt">y =</span> <span class="st">'Minimum weight of child node'</span></a>
<a class="sourceLine" id="cb14-35" title="35">  )</a></code></pre></div>
<p><img src="get_started_files/figure-html/unnamed-chunk-14-1.png" width="672"></p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">

        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li>
<a href="#xgboost-surv"><code>xgboost.surv</code></a><ul class="nav nav-pills nav-stacked">
<li><a href="#getting-started">Getting started</a></li>
      <li><a href="#mayo-clinic-primary-biliary-cirrhosis-data">Mayo Clinic Primary Biliary Cirrhosis Data</a></li>
      <li><a href="#as_sgb_params"><code>as_sgb_params</code></a></li>
      <li><a href="#cat_herding"><code>cat_herding</code></a></li>
      <li><a href="#sgb_label"><code>sgb_label</code></a></li>
      <li><a href="#sgb_data-and-sgb_fit"><code>sgb_data</code> and <code>sgb_fit</code></a></li>
      <li><a href="#eval_bscore"><code>eval_bscore</code></a></li>
      </ul>
</li>
      </ul>
</div>
      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by Byron Jaeger.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.4.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
